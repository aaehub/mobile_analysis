## 6. Data Transformation: Convert Prices to USD and Extract Numeric Features

# Transform normlized.csv: Convert prices to USD, create device_age, and extract numeric features
import re
from datetime import datetime

# Load the normalized dataset
df_norm = pd.read_csv('normlized.csv', encoding='latin1')
print(f"Loaded normlized.csv: {df_norm.shape[0]} rows, {df_norm.shape[1]} columns")

# Currency conversion rates (approximate 2025 rates)
CONVERSION_RATES = {
    'PKR': 280.0,  # Pakistani Rupee to USD
    'INR': 83.0,   # Indian Rupee to USD
    'CNY': 7.2,    # Chinese Yuan to USD
    'AED': 3.67,   # UAE Dirham to USD
    'USD': 1.0     # Already in USD
}

def convert_price_to_usd(price_str):
    """Convert price string to USD value"""
    if pd.isna(price_str) or str(price_str).strip() == '' or 'Not available' in str(price_str):
        return np.nan
    
    price_str = str(price_str).strip()
    
    # Extract currency and amount
    match = re.search(r'([A-Z]{3})\s*([\d,]+\.?\d*)', price_str)
    if not match:
        num_match = re.search(r'([\d,]+\.?\d*)', price_str)
        if num_match:
            amount = float(num_match.group(1).replace(',', ''))
            return amount
        return np.nan
    
    currency = match.group(1)
    amount_str = match.group(2).replace(',', '')
    
    try:
        amount = float(amount_str)
        if currency in CONVERSION_RATES:
            return amount / CONVERSION_RATES[currency]
        else:
            return amount
    except:
        return np.nan

# Convert all price columns to USD
price_columns = ['Launched Price (Pakistan)', 'Launched Price (India)', 
                 'Launched Price (China)', 'Launched Price (USA)', 'Launched Price (Dubai)']

for col in price_columns:
    df_norm[col] = df_norm[col].apply(convert_price_to_usd)
    new_col_name = col.replace('Launched Price', 'Price USD').replace(' (', '_').replace(')', '')
    df_norm = df_norm.rename(columns={col: new_col_name})

print("\n✅ All prices converted to USD")

# Create device_age = current_year - launched_year
current_year = datetime.now().year
df_norm['device_age'] = current_year - df_norm['Launched Year']
df_norm = df_norm.drop(columns=['Launched Year'])

# Convert Mobile Weight: "174g" → 174
def extract_weight(weight_str):
    if pd.isna(weight_str):
        return np.nan
    match = re.search(r'(\d+(?:\.\d+)?)', str(weight_str))
    return float(match.group(1)) if match else np.nan

df_norm['weight_g'] = df_norm['Mobile Weight'].apply(extract_weight)
df_norm = df_norm.drop(columns=['Mobile Weight'])

# Convert RAM: "6GB" → 6
def extract_ram(ram_str):
    if pd.isna(ram_str):
        return np.nan
    match = re.search(r'(\d+(?:\.\d+)?)', str(ram_str))
    return float(match.group(1)) if match else np.nan

df_norm['ram_gb'] = df_norm['RAM'].apply(extract_ram)
df_norm = df_norm.drop(columns=['RAM'])

# Convert Screen Size: "6.1 inches" → 6.1
def extract_screen_size(screen_str):
    if pd.isna(screen_str):
        return np.nan
    match = re.search(r'(\d+(?:\.\d+)?)', str(screen_str))
    return float(match.group(1)) if match else np.nan

df_norm['screen_in'] = df_norm['Screen Size'].apply(extract_screen_size)
df_norm = df_norm.drop(columns=['Screen Size'])

# Convert Battery Capacity: "3,600mAh" → 3600
def extract_battery(battery_str):
    if pd.isna(battery_str):
        return np.nan
    cleaned = str(battery_str).replace(',', '')
    match = re.search(r'(\d+(?:\.\d+)?)', cleaned)
    return float(match.group(1)) if match else np.nan

df_norm['battery_mah'] = df_norm['Battery Capacity'].apply(extract_battery)
df_norm = df_norm.drop(columns=['Battery Capacity'])

# Convert Front Camera: Extract max, sum, and count
def extract_camera_mp(camera_str):
    if pd.isna(camera_str):
        return np.nan, np.nan, np.nan
    matches = re.findall(r'(\d+(?:\.\d+)?)\s*MP', str(camera_str), re.IGNORECASE)
    if not matches:
        return np.nan, np.nan, np.nan
    mp_values = [float(m) for m in matches]
    return max(mp_values), sum(mp_values), len(mp_values)

front_results = df_norm['Front Camera'].apply(extract_camera_mp)
df_norm['front_mp_max'] = front_results.apply(lambda x: x[0])
df_norm['front_mp_sum'] = front_results.apply(lambda x: x[1])
df_norm['front_cam_count'] = front_results.apply(lambda x: x[2])
df_norm = df_norm.drop(columns=['Front Camera'])

# Convert Back Camera: Extract max, sum, and count
back_results = df_norm['Back Camera'].apply(extract_camera_mp)
df_norm['back_mp_max'] = back_results.apply(lambda x: x[0])
df_norm['back_mp_sum'] = back_results.apply(lambda x: x[1])
df_norm['back_cam_count'] = back_results.apply(lambda x: x[2])
df_norm = df_norm.drop(columns=['Back Camera'])

print("\n✅ All transformations complete!")
print(f"Final shape: {df_norm.shape}")
print(f"\nNew numeric columns:")
numeric_cols = ['device_age', 'weight_g', 'ram_gb', 'screen_in', 'battery_mah', 
                'front_mp_max', 'front_mp_sum', 'front_cam_count',
                'back_mp_max', 'back_mp_sum', 'back_cam_count']
print(numeric_cols)
print(f"\nPrice columns (all in USD):")
price_cols = [col for col in df_norm.columns if 'Price USD' in col]
print(price_cols)
print(f"\nFirst few rows:")
print(df_norm.head())
